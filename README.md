# Apuntador OAuth Backend

Unified backend to manage OAuth 2.0 authentication with multiple cloud providers (Google Drive, Dropbox, OneDrive).

## Architecture

```
Apuntador Client (Web/Android/iOS/Desktop)
    â†“
OAuth Proxy Backend (FastAPI)
    â†“
OAuth Providers (Google, Dropbox, etc.)
```

## Features

- âœ… OAuth 2.0 with PKCE for maximum security
- âœ… Support for multiple providers: Google Drive, Dropbox, OneDrive
- âœ… Automatic refresh token management
- âœ… Secure client secrets in the backend
- âœ… Unified REST API for all clients
- âœ… CORS configured for development and production

## Requirements

- Python 3.11+
- pip or uv (package manager)

## Installation

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Or using uv (faster)
uv pip install -r requirements.txt
```

## Configuration

Create a `.env` file in the root:

```env
# Server
HOST=0.0.0.0
PORT=8000
DEBUG=true
SECRET_KEY=your-super-secure-secret-key-change-in-production

# CORS - Allowed domains (comma-separated)
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,capacitor://localhost,tauri://localhost

# Google Drive OAuth
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=http://localhost:8000/oauth/callback/googledrive

# Dropbox OAuth
DROPBOX_CLIENT_ID=your-dropbox-app-key
DROPBOX_CLIENT_SECRET=your-dropbox-app-secret
DROPBOX_REDIRECT_URI=http://localhost:8000/oauth/callback/dropbox

# OneDrive OAuth (optional)
# ONEDRIVE_CLIENT_ID=your-client-id
# ONEDRIVE_CLIENT_SECRET=your-client-secret
# ONEDRIVE_REDIRECT_URI=http://localhost:8000/oauth/callback/onedrive
```

## Running

### Development

```bash
# Using uvicorn directly
uvicorn apuntador.main:app --reload --host 0.0.0.0 --port 8000

# Or using the development script
python -m apuntador.main
```

### Production

```bash
# With Gunicorn + Uvicorn workers
gunicorn apuntador.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
```

## API Endpoints

### Start OAuth authorization

```http
POST /oauth/authorize/{provider}
Content-Type: application/json

{
  "code_verifier": "string",  // PKCE code verifier generated by client
  "state": "string"           // Optional state for validation
}

Response:
{
  "authorization_url": "https://...",
  "state": "string"
}
```

### OAuth callback (internal)

```http
GET /oauth/callback/{provider}?code=xxx&state=xxx
```

This endpoint is called by the OAuth provider after authorization.

### Exchange code for token

```http
POST /oauth/token/{provider}
Content-Type: application/json

{
  "code": "string",
  "code_verifier": "string",
  "state": "string"
}

Response:
{
  "access_token": "string",
  "refresh_token": "string",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### Refresh access token

```http
POST /oauth/refresh/{provider}
Content-Type: application/json

{
  "refresh_token": "string"
}

Response:
{
  "access_token": "string",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### Revoke access

```http
POST /oauth/revoke/{provider}
Content-Type: application/json

{
  "token": "string"
}

Response:
{
  "success": true
}
```

### Health check

```http
GET /health

Response:
{
  "status": "ok",
  "version": "1.0.0"
}
```

### Get CA certificate (mTLS)

```http
GET /device/ca-certificate

Response:
{
  "certificate": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "format": "PEM",
  "usage": "Use this certificate for mTLS client authentication"
}
```

### Get CA certificate pin (Certificate Pinning)

```http
GET /device/ca-certificate-pin

Response:
{
  "sha256_base64": "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=",
  "sha256_hex": "0000000000000000000000000000000000000000000000000000000000000000",
  "certificate_pem": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "algorithm": "SHA-256",
  "usage": "Use sha256_base64 for iOS/Android certificate pinning"
}
```

**Use case:** Implement certificate pinning in mobile apps to prevent MITM attacks.

See: `apuntador/docs/CERTIFICATE_PINNING.md` for implementation guide.

## Supported providers

- `googledrive` - Google Drive API
- `dropbox` - Dropbox API
- `onedrive` - Microsoft OneDrive API (optional)

## Security

- âœ… Client secrets never exposed to the client
- âœ… PKCE (Proof Key for Code Exchange) mandatory
- âœ… State validation to prevent CSRF
- âœ… mTLS with client certificates (Android/iOS)
- âœ… Certificate pinning support for mobile apps
- âœ… Strictly configured CORS
- âœ… Rate limiting (TODO)
- âœ… Audit logging

## Production Setup

### Certificate Authority (CA) Setup

For mTLS authentication, you need to set up a private Certificate Authority:

#### 1. Generate CA Private Key and Certificate

```bash
# Generate CA private key (keep this VERY secure!)
openssl genrsa -out ca-key.pem 4096

# Generate CA certificate (valid for 10 years)
openssl req -new -x509 -days 3650 -key ca-key.pem -out ca-cert.pem \
  -subj "/C=US/ST=State/L=City/O=Apuntador/CN=Apuntador CA"

# Verify CA certificate
openssl x509 -in ca-cert.pem -text -noout
```

#### 2. Store CA Private Key in AWS Secrets Manager

```bash
# Install AWS CLI if not already installed
# Configure AWS credentials: aws configure

# Store CA private key (CRITICAL: Never commit this to git!)
aws secretsmanager create-secret \
  --name apuntador/ca/private-key \
  --description "Apuntador CA private key for mTLS certificate signing" \
  --secret-string file://ca-key.pem \
  --region eu-west-1

# Store CA certificate (public, but stored for convenience)
aws secretsmanager create-secret \
  --name apuntador/ca/certificate \
  --description "Apuntador CA public certificate" \
  --secret-string file://ca-cert.pem \
  --region eu-west-1

# Verify secrets were created
aws secretsmanager list-secrets --region eu-west-1 | grep apuntador/ca
```

#### 3. Set Permissions for Lambda Execution Role

Your Lambda function needs permission to read these secrets:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-west-1:*:secret:apuntador/ca/*"
      ]
    }
  ]
}
```

This is already configured in `iac/modules/lambda/main.tf`.

### Environment Variables for Production

Required environment variables for AWS Lambda (set via Terraform):

```bash
# AWS Secrets Manager paths
CA_PRIVATE_KEY_SECRET_ARN=arn:aws:secretsmanager:eu-west-1:ACCOUNT_ID:secret:apuntador/ca/private-key-XXXXXX
CA_CERTIFICATE_SECRET_ARN=arn:aws:secretsmanager:eu-west-1:ACCOUNT_ID:secret:apuntador/ca/certificate-XXXXXX

# DynamoDB table for certificate whitelist
CERTIFICATE_TABLE_NAME=apuntador-certificates

# Infrastructure provider (local for dev, aws for production)
INFRASTRUCTURE_PROVIDER=aws
SECRETS_PROVIDER=aws
CERTIFICATE_DB_PROVIDER=aws

# OAuth credentials (store in Secrets Manager or Terraform variables)
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=https://api.apuntador.io/oauth/callback/googledrive

DROPBOX_CLIENT_ID=your-dropbox-app-key
DROPBOX_CLIENT_SECRET=your-dropbox-app-secret
DROPBOX_REDIRECT_URI=https://api.apuntador.io/oauth/callback/dropbox

# Security
SECRET_KEY=generate-strong-random-key-min-32-chars
ALLOWED_ORIGINS=https://apuntador.io,https://app.apuntador.io

# Backend mode
DEBUG=false
LOG_LEVEL=INFO
```

### DynamoDB Certificate Whitelist Setup

The certificate whitelist is automatically created by Terraform in `iac/stacks/01.applications/03.database.tf`.

Table structure:
- **Table Name**: `apuntador-certificates`
- **Partition Key**: `serial_number` (String) - Certificate serial number
- **Attributes**:
  - `device_id` (String) - Unique device identifier
  - `platform` (String) - android, ios, or desktop
  - `issued_at` (Number) - Unix timestamp
  - `expires_at` (Number) - Unix timestamp
  - `status` (String) - active, revoked, or expired

Certificates are automatically added when devices enroll via `/device/enroll` endpoint.

### OAuth Provider Configuration

#### Google Drive

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable Google Drive API
4. Create OAuth 2.0 credentials:
   - Application type: Web application
   - Authorized redirect URIs: `https://api.apuntador.io/oauth/callback/googledrive`
5. Copy Client ID and Client Secret to environment variables

#### Dropbox

1. Go to [Dropbox App Console](https://www.dropbox.com/developers/apps)
2. Create a new app:
   - API: Scoped access
   - Access: Full Dropbox
3. Configure OAuth2 redirect URIs: `https://api.apuntador.io/oauth/callback/dropbox`
4. Copy App key (Client ID) and App secret to environment variables

### Certificate Lifecycle

1. **Enrollment**: Device generates CSR â†’ Backend signs with CA â†’ Returns certificate (7-30 days validity)
2. **Renewal**: Client requests renewal when < 5 days remaining â†’ Backend issues new certificate
3. **Revocation**: Admin or automated process marks certificate as revoked in DynamoDB
4. **Validation**: Every mTLS request checks certificate against whitelist (cached with 5-min TTL)

See `docs/CERTIFICATE_LIFECYCLE.md` for detailed workflow.

## Deployment

### Docker

```bash
docker build -t apuntador-oauth-backend .
docker run -p 8000:8000 --env-file .env apuntador-oauth-backend
```

### Railway / Render / Fly.io

1. Connect your repository
2. Configure environment variables
3. Automatic deploy

## Development

```bash
# Run tests
pytest

# Linting
ruff check .

# Format
ruff format .

# Type checking
mypy app/
```

## Project structure

```
apuntador-backend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ apuntador/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ main.py              # FastAPI application entry point
â”‚       â”œâ”€â”€ lambda_main.py       # AWS Lambda handler (Mangum)
â”‚       â”œâ”€â”€ config.py            # Pydantic Settings configuration
â”‚       â”œâ”€â”€ openapi.py           # OpenAPI/Swagger documentation
â”‚       â”œâ”€â”€ api/
â”‚       â”‚   â””â”€â”€ v1/
â”‚       â”‚       â”œâ”€â”€ __init__.py  # API route prefixes
â”‚       â”‚       â”œâ”€â”€ oauth/       # OAuth 2.0 endpoints
â”‚       â”‚       â””â”€â”€ device/      # Device enrollment & mTLS
â”‚       â”œâ”€â”€ core/
â”‚       â”‚   â””â”€â”€ logging.py       # Loguru configuration
â”‚       â”œâ”€â”€ middleware/
â”‚       â”‚   â”œâ”€â”€ __init__.py      # TraceID middleware
â”‚       â”‚   â””â”€â”€ mtls_validation.py  # Client certificate validation
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ oauth.py         # OAuth request/response models
â”‚       â”‚   â”œâ”€â”€ device.py        # Device enrollment models
â”‚       â”‚   â””â”€â”€ errors.py        # RFC 7807 Problem Details
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â”œâ”€â”€ oauth/
â”‚       â”‚   â”‚   â”œâ”€â”€ oauth_base.py      # Abstract OAuth service
â”‚       â”‚   â”‚   â”œâ”€â”€ googledrive.py     # Google Drive OAuth
â”‚       â”‚   â”‚   â””â”€â”€ dropbox.py         # Dropbox OAuth
â”‚       â”‚   â”œâ”€â”€ certificate/
â”‚       â”‚   â”‚   â”œâ”€â”€ certificate_authority.py  # CA signing
â”‚       â”‚   â”‚   â”œâ”€â”€ certificate_manager.py    # Certificate lifecycle
â”‚       â”‚   â”‚   â””â”€â”€ certificate_storage.py    # DynamoDB interface
â”‚       â”‚   â””â”€â”€ device_attestation/
â”‚       â”‚       â”œâ”€â”€ android_safetynet.py      # Android attestation
â”‚       â”‚       â””â”€â”€ ios_devicecheck.py        # iOS attestation
â”‚       â”œâ”€â”€ infrastructure/       # Repository pattern for cloud abstraction
â”‚       â”‚   â”œâ”€â”€ repositories/
â”‚       â”‚   â”‚   â”œâ”€â”€ certificate_repository.py
â”‚       â”‚   â”‚   â”œâ”€â”€ secrets_repository.py
â”‚       â”‚   â”‚   â””â”€â”€ storage_repository.py
â”‚       â”‚   â”œâ”€â”€ implementations/
â”‚       â”‚   â”‚   â”œâ”€â”€ local/       # File-based (development)
â”‚       â”‚   â”‚   â””â”€â”€ aws/         # DynamoDB, S3, Secrets Manager
â”‚       â”‚   â””â”€â”€ factory.py       # Provider selection
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ pkce.py          # PKCE utilities
â”‚           â”œâ”€â”€ security.py      # Token signing, state generation
â”‚           â””â”€â”€ crypto/
â”‚               â”œâ”€â”€ csr.py       # CSR parsing and validation
â”‚               â””â”€â”€ x509.py      # Certificate utilities
â”œâ”€â”€ iac/                         # Terraform infrastructure
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â””â”€â”€ lambda/              # Reusable Lambda module
â”‚   â””â”€â”€ stacks/
â”‚       â””â”€â”€ 01.applications/
â”‚           â”œâ”€â”€ 01.network.tf    # VPC, subnets (if needed)
â”‚           â”œâ”€â”€ 02.domain-ssl.tf # API Gateway, ACM, Route53
â”‚           â”œâ”€â”€ 03.database.tf   # DynamoDB tables
â”‚           â”œâ”€â”€ 04.application.tf # Lambda function
â”‚           â””â”€â”€ configuration.application.tfvars
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ AWS_DEPLOYMENT_GUIDE.md
â”‚   â”œâ”€â”€ CERTIFICATE_LIFECYCLE.md
â”‚   â”œâ”€â”€ MTLS_IMPLEMENTATION_PLAN.md
â”‚   â””â”€â”€ INFRASTRUCTURE_ABSTRACTION.md
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â””â”€â”€ integration/
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Dockerfile.lambda            # AWS Lambda container
â”œâ”€â”€ Makefile                     # Development commands
â”œâ”€â”€ pyproject.toml               # Python project configuration
â””â”€â”€ README.md
```

## ðŸ“„ License

MIT License - see [LICENSE](LICENSE) file for details.
