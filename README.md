# Apuntador OAuth Backend

Unified backend to manage OAuth 2.0 authentication with multiple cloud providers (Google Drive, Dropbox, OneDrive).

## Architecture

```
Apuntador Client (Web/Android/iOS/Desktop)
    ↓
OAuth Proxy Backend (FastAPI)
    ↓
OAuth Providers (Google, Dropbox, etc.)
```

## Features

- ✅ OAuth 2.0 with PKCE for maximum security
- ✅ Support for multiple providers: Google Drive, Dropbox, OneDrive
- ✅ Automatic refresh token management
- ✅ Secure client secrets in the backend
- ✅ Unified REST API for all clients
- ✅ CORS configured for development and production

## Requirements

- Python 3.11+
- pip or uv (package manager)

## Installation

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Or using uv (faster)
uv pip install -r requirements.txt
```

## Configuration

Create a `.env` file in the root:

```env
# Server
HOST=0.0.0.0
PORT=8000
DEBUG=true
SECRET_KEY=your-super-secure-secret-key-change-in-production

# CORS - Allowed domains (comma-separated)
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,capacitor://localhost,tauri://localhost

# Google Drive OAuth
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=http://localhost:8000/api/oauth/callback/googledrive

# Dropbox OAuth
DROPBOX_CLIENT_ID=your-dropbox-app-key
DROPBOX_CLIENT_SECRET=your-dropbox-app-secret
DROPBOX_REDIRECT_URI=http://localhost:8000/api/oauth/callback/dropbox

# OneDrive OAuth (optional)
# ONEDRIVE_CLIENT_ID=your-client-id
# ONEDRIVE_CLIENT_SECRET=your-client-secret
# ONEDRIVE_REDIRECT_URI=http://localhost:8000/api/oauth/callback/onedrive
```

## Running

### Development

```bash
# Using uvicorn directly
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Or using the development script
python -m app.main
```

### Production

```bash
# With Gunicorn + Uvicorn workers
gunicorn app.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
```

## API Endpoints

### Start OAuth authorization

```http
POST /api/oauth/authorize/{provider}
Content-Type: application/json

{
  "code_verifier": "string",  // PKCE code verifier generated by client
  "state": "string"           // Optional state for validation
}

Response:
{
  "authorization_url": "https://...",
  "state": "string"
}
```

### OAuth callback (internal)

```http
GET /api/oauth/callback/{provider}?code=xxx&state=xxx
```

This endpoint is called by the OAuth provider after authorization.

### Exchange code for token

```http
POST /api/oauth/token/{provider}
Content-Type: application/json

{
  "code": "string",
  "code_verifier": "string",
  "state": "string"
}

Response:
{
  "access_token": "string",
  "refresh_token": "string",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### Refresh access token

```http
POST /api/oauth/refresh/{provider}
Content-Type: application/json

{
  "refresh_token": "string"
}

Response:
{
  "access_token": "string",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### Revoke access

```http
POST /api/oauth/revoke/{provider}
Content-Type: application/json

{
  "token": "string"
}

Response:
{
  "success": true
}
```

### Health check

```http
GET /health

Response:
{
  "status": "ok",
  "version": "1.0.0"
}
```

## Supported providers

- `googledrive` - Google Drive API
- `dropbox` - Dropbox API
- `onedrive` - Microsoft OneDrive API (optional)

## Security

- ✅ Client secrets never exposed to the client
- ✅ PKCE (Proof Key for Code Exchange) mandatory
- ✅ State validation to prevent CSRF
- ✅ Strictly configured CORS
- ✅ Rate limiting (TODO)
- ✅ Audit logging

## Deployment

### Docker

```bash
docker build -t apuntador-oauth-backend .
docker run -p 8000:8000 --env-file .env apuntador-oauth-backend
```

### Railway / Render / Fly.io

1. Connect your repository
2. Configure environment variables
3. Automatic deploy

## Development

```bash
# Run tests
pytest

# Linting
ruff check .

# Format
ruff format .

# Type checking
mypy app/
```

## Project structure

```
apuntador-oauth-backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # Main FastAPI application
│   ├── config.py            # Configuration and environment variables
│   ├── models.py            # Pydantic models
│   ├── dependencies.py      # Injectable dependencies
│   ├── routers/
│   │   ├── __init__.py
│   │   ├── oauth.py         # Main OAuth routes
│   │   └── health.py        # Health checks
│   ├── services/
│   │   ├── __init__.py
│   │   ├── oauth_base.py    # Base class for OAuth
│   │   ├── googledrive.py   # Google Drive service
│   │   ├── dropbox.py       # Dropbox service
│   │   └── onedrive.py      # OneDrive service
│   └── utils/
│       ├── __init__.py
│       ├── pkce.py          # PKCE utilities
│       └── security.py      # Security utilities
├── tests/
│   ├── __init__.py
│   ├── test_oauth.py
│   └── test_services.py
├── .env.example
├── .gitignore
├── Dockerfile
├── requirements.txt
├── pyproject.toml
└── README.md
```

## License

Same as Apuntador
